<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipin'</title>
    <meta name="description" content="sample text">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <!-- CSRF„Éà„Éº„ÇØ„É≥ -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/sanitize.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="page-home">

<section id="loading">
    <div class="loading">
        <div class="pack"></div>
        <div class="fuels">
            <div></div><div></div><div></div><div></div>
        </div>
    </div>
</section>

<div class="container">
    <!-- Top Navbar -->
    <header class="top-navbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="„É°„Éã„É•„Éº„ÇíÈñã„Åè">
            <span></span>
        </button>
        <div class="title">Recipin'</div>
        <div class="header-right">
            <!-- „Éò„ÉÉ„ÉÄ„ÉºÂè≥ÂÅ¥ -->
            <div class="user-info" sec:authorize="isAuthenticated()">
                <span th:text="'„Çà„ÅÜ„Åì„Åù„ÄÅ' + ${#authentication.name} + '„Åï„Çì'">„É¶„Éº„Ç∂„ÉºÂêç</span>
            </div>
            <div class="header-actions" sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit" class="logout-btn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </form>
            </div>

        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã">
                    ‚úï
                </button>
            </div>
            <ul>
                <li>
                    <a href="/home" class="home-button">
                        <img src="/images/icons/home.svg" alt="„Éõ„Éº„É†" />
                        <span>„Éõ„Éº„É†</span>
                    </a>
                </li>
                <li>
                    <a href="/home">
                        <img src="/images/icons/book.svg" alt="„É¨„Ç∑„Éî‰∏ÄË¶ß" />
                        <span>„É¨„Ç∑„Éî‰∏ÄË¶ß</span>
                    </a>
                </li>
                <li>
                    <a href="/recipes/favorites">
                        <img src="/images/icons/heart.svg" alt="„ÅäÊ∞ó„Å´ÂÖ•„Çä">
                        <span>„ÅäÊ∞ó„Å´ÂÖ•„Çä</span>
                    </a>
                </li>
                <li>
                    <div class="menu-item" onclick="showCategoriesPage()">
                        <img src="/images/icons/category.svg" alt="„Ç´„ÉÜ„Ç¥„É™" />
                        <span>„Ç´„ÉÜ„Ç¥„É™‰∏ÄË¶ß</span>
                    </div>
                </li>
                <li>
                    <div class="menu-item" onclick="showUserInfo()">
                        <img src="/images/icons/user.svg" alt="„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±" />
                        <span>„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±</span>
                    </div>
                </li>
                <li>
                    <div class="menu-item" onclick="showHelp()">
                        <img src="/images/icons/interrogation.svg" alt="„Éò„É´„Éó" />
                        <span>„Éò„É´„Éó</span>
                    </div>
                </li>
                <li class="bottom">
                    <div class="menu-item" onclick="showSettings()">
                        <img src="/images/icons/settings.svg" alt="Ë®≠ÂÆö" />
                        <span>Ë®≠ÂÆö</span>
                    </div>
                </li>
                <li class="bottom" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" style="margin:0;">
                        <button type="submit" class="logout-sidebar-btn">
                            <img src="/images/icons/logout.svg" alt="„É≠„Ç∞„Ç¢„Ç¶„Éà" />
                            <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="main-toolbar">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="„É¨„Ç∑„ÉîÂêç„ÇÑ„Ç´„ÉÜ„Ç¥„É™„ÅßÊ§úÁ¥¢..." />
                <span class="search-icon">
                <img src="/images/icons/search.svg" alt="Ê§úÁ¥¢" />
              </span>
            </div>
            <div class="add-button-container">
                <a href="/recipes/new" class="add-button">
                    <span class="add-text">ËøΩÂä†</span>
                    <img src="/images/icons/add.svg" alt="ËøΩÂä†">
                </a>
            </div>
        </div>

        <!-- ÈÄöÂ∏∏„ÅÆ„É¨„Ç∑„ÉîË°®Á§∫ -->
        <div id="normalView">
            <div class="section-header">
                <div class="section-title">
                    <h2 th:if="${favoritesPage != null and favoritesPage}" th:text="'„ÅäÊ∞ó„Å´ÂÖ•„Çä„É¨„Ç∑„Éî‰∏ÄË¶ß (' + ${#lists.size(recipes)} + '‰ª∂)'">„ÅäÊ∞ó„Å´ÂÖ•„Çä</h2>
                    <h2 th:if="${categoryName != null}" th:text="'„Ç´„ÉÜ„Ç¥„É™Ôºö' + ${categoryName} + ' (' + ${#lists.size(recipes)} + '‰ª∂)'">„Ç´„ÉÜ„Ç¥„É™</h2>
                    <h2 th:if="${favoritesPage == null and categoryName == null}" th:text="'„Åô„Åπ„Å¶„ÅÆ„É¨„Ç∑„Éî‰∏ÄË¶ß (' + ${#lists.size(recipes)} + '‰ª∂)'">„Åô„Åπ„Å¶„ÅÆ„É¨„Ç∑„Éî</h2>
                </div>
            </div>

            <!-- ÊàêÂäü„Éª„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
            <div th:if="${successMessage}" class="flash-message success-message">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="flash-message error-message">
                <span th:text="${errorMessage}"></span>
            </div>

            <p th:if="${#lists.isEmpty(recipes)}" class="no-recipes-message">„É¨„Ç∑„Éî„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
            <p id="noResultsMessage" class="no-results-message" style="display: none;">Ê§úÁ¥¢Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„Çã„É¨„Ç∑„Éî„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>

            <!-- „É¨„Ç∑„Éî„Ç´„Éº„ÉâË°®Á§∫ -->
            <div class="card-list" th:if="${not #lists.isEmpty(recipes)}">
                <section class="card" th:each="recipe : ${recipes}" th:attr="data-recipe-id=${recipe.id}">
                    <div class="card-menu">
                        <button class="menu-toggle" aria-label="„É°„Éã„É•„Éº„ÇíÈñã„Åè">Ô∏ô</button>
                        <div class="menu-content">
                            <form th:action="@{'/recipes/edit/' + ${recipe.id}}" method="get" style="margin:0;">
                                <button type="submit" class="edit-button">Á∑®ÈõÜ</button>
                            </form>
                            <button type="button" class="delete-button" th:attr="data-recipe-id=${recipe.id}">ÂâäÈô§</button>
                        </div>
                    </div>
                    <div class="card-image-wrapper">
                        <img th:if="${recipe.imagePath != null}" th:src="@{${recipe.imagePath}}" alt="„É¨„Ç∑„ÉîÁîªÂÉè" class="card-image" loading="lazy" />
                        <img th:if="${recipe.imagePath == null}" th:src="@{/images/no-image.png}" alt="„É¨„Ç∑„ÉîÁîªÂÉè„Å™„Åó" class="card-no-image" loading="lazy" />
                        <div class="card-overlay">
                            <h2 th:text="${recipe.title}" class="overlay-title">„É¨„Ç∑„ÉîÂêç</h2>
                            <button class="favorite-toggle" th:attr="data-id=${recipe.id}" aria-label="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†">
                                <img class="heart-image" th:src="${recipe.favorite} ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'" alt="„ÅäÊ∞ó„Å´ÂÖ•„Çä" />
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                      <span th:each="cat : ${recipe.categories}">
                         <a th:href="@{'/recipes/category/' + ${cat}}"
                            th:text="${cat}"
                            th:classappend="'category-tag ' + ${cat}"
                            title="„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„É¨„Ç∑„Éî„ÇíË°®Á§∫">
                            „Ç´„ÉÜ„Ç¥„É™
                        </a>
                      </span>
                    </div>
                </section>
            </div>
        </div>

        <!-- „Ç´„ÉÜ„Ç¥„É™Âà•Ë°®Á§∫„Éì„É•„Éº -->
        <div id="categoriesView" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <h2>üìÇ „Ç´„ÉÜ„Ç¥„É™Âà•„É¨„Ç∑„Éî‰∏ÄË¶ß</h2>
                </div>
                <button class="back-button" onclick="hideCategoriesPage()">
                    <span>‚Üê Êàª„Çã</span>
                </button>
            </div>
            <div id="categoriesContainer">
                <!-- ÂãïÁöÑ„Å´„Ç´„ÉÜ„Ç¥„É™Âà•„É¨„Ç∑„Éî„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
            </div>
        </div>
    </main>
</div>

<!-- „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
<div id="modalOverlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">„Çø„Ç§„Éà„É´</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- ÂãïÁöÑ„Å´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
        </div>
    </div>
</div>

<script>
    // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÁÆ°ÁêÜ„ÇØ„É©„Çπ
class DarkModeManager {
    constructor() {
        this.init();
    }

    init() {
        // ÂàùÊúüË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
        this.loadSettings();
        // Ë®≠ÂÆöÂ§âÊõ¥„ÅÆÁõ£Ë¶ñ
        this.watchStorageChanges();
    }

    loadSettings() {
        const darkMode = localStorage.getItem('darkMode') === 'true';
        const compactView = localStorage.getItem('compactView') === 'true';

        if (darkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }

        if (compactView) {
            document.querySelector('.card-list')?.classList.add('compact-view');
        }
    }

    toggle() {
        const isDark = document.body.classList.contains('dark-mode');
        if (isDark) {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'false');
        } else {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'true');
        }

        // ‰ªñ„ÅÆ„Çø„Éñ/„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´Â§âÊõ¥„ÇíÈÄöÁü•
        this.broadcastChange();
    }

    watchStorageChanges() {
        // localStorage „ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñÔºà‰ªñ„ÅÆ„Çø„Éñ„Åã„Çâ„ÅÆÂ§âÊõ¥Ôºâ
        window.addEventListener('storage', (e) => {
            if (e.key === 'darkMode') {
                this.loadSettings();
            }
        });

        // Âêå‰∏Ä„Çø„ÉñÂÜÖ„Åß„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
        window.addEventListener('darkmodechange', () => {
            this.loadSettings();
        });
    }

    broadcastChange() {
        // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´ÔºàÂêå‰∏Ä„Çø„ÉñÂÜÖÔºâ
        window.dispatchEvent(new Event('darkmodechange'));
    }
}

// „Ç∞„É≠„Éº„Éê„É´„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ
const darkModeManager = new DarkModeManager();

// Ê§úÁ¥¢Ê©üËÉΩ„ÅÆÊîπÂñÑ
const searchInput = document.getElementById('searchInput');
const recipeCards = document.querySelectorAll('.card');

// Ê≠£Ë¶èÂåñÈñ¢Êï∞Ôºà„Ç´„Çø„Ç´„Éä‚Üí„Å≤„Çâ„Åå„Å™„ÄÅÂ∞èÊñáÂ≠óÂåñ„ÄÅÂÖ®Ëßí‚ÜíÂçäËßíÔºâ
function normalizeText(str) {
  return str
    .toLowerCase()
    .normalize("NFKC")
    .replace(/[„Ç°-„É≥]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60));
}

// „É™„Ç¢„É´„Çø„Ç§„É†Ê§úÁ¥¢Ê©üËÉΩ
function performSearch() {
    const keywordRaw = searchInput.value.trim();
    const keyword = normalizeText(keywordRaw);

    const noResultsMessage = document.getElementById('noResultsMessage');
    const noRecipesMessage = document.querySelector('.no-recipes-message');
    let visibleCardCount = 0;

    // Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÂÖ®„Å¶Ë°®Á§∫
    if (keyword === '') {
        recipeCards.forEach(card => {
            card.style.display = '';
            visibleCardCount++;
        });
        noResultsMessage.style.display = 'none';
        return;
    }

    recipeCards.forEach(card => {
        const titleElement = card.querySelector('h2');
        const categoryElements = card.querySelectorAll('.category-tag');

        const title = normalizeText(titleElement ? titleElement.textContent : '');
        const categories = Array.from(categoryElements).map(el =>
            normalizeText(el ? el.textContent : '')
        ).join(' ');

        const titleMatch = title.includes(keyword);
        const categoryMatch = categories.includes(keyword);

        if (titleMatch || categoryMatch) {
            card.style.display = '';
            visibleCardCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // Ê§úÁ¥¢ÁµêÊûú„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫Âà∂Âæ°
    if (visibleCardCount === 0) {
        noResultsMessage.style.display = 'block';
        if (noRecipesMessage) {
            noRecipesMessage.style.display = 'none';
        }
    } else {
        noResultsMessage.style.display = 'none';
    }
}

// „Çµ„Ç§„Éâ„Éê„ÉºÊ©üËÉΩ
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
}

function checkScreenSize() {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.sidebar-toggle');

    if (window.innerWidth > 768) {
        // „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Çµ„Ç§„Ç∫„ÅÆÂ†¥Âêà„ÄÅ„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
        sidebar.classList.remove('active');
    }
}

// „Ç´„ÉÜ„Ç¥„É™Âà•Ë°®Á§∫Ê©üËÉΩ
async function showCategoriesPage() {
    try {
        // ÂÖ®„É¨„Ç∑„Éî„ÇíÂèñÂæó
        const allRecipes = Array.from(document.querySelectorAll('.card')).map(card => {
            const titleElement = card.querySelector('.overlay-title');
            const categoryElements = card.querySelectorAll('.category-tag');
            const heartImage = card.querySelector('.heart-image');
            const recipeImage = card.querySelector('.card-image, .card-no-image');

            return {
                id: card.getAttribute('data-recipe-id'),
                title: titleElement ? titleElement.textContent : '',
                categories: Array.from(categoryElements).map(el => el.textContent.trim()),
                isFavorite: heartImage ? heartImage.src.includes('heart_active') : false,
                imagePath: recipeImage ? recipeImage.src : '',
                hasImage: recipeImage ? !recipeImage.src.includes('no-image') : false
            };
        });

        // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„É¨„Ç∑„Éî„ÇíÂàÜÈ°û
        const categoryMap = new Map();

        allRecipes.forEach(recipe => {
            recipe.categories.forEach(category => {
                if (!categoryMap.has(category)) {
                    categoryMap.set(category, []);
                }
                categoryMap.get(category).push(recipe);
            });
        });

        // „Ç´„ÉÜ„Ç¥„É™„Åå„Å™„ÅÑ„É¨„Ç∑„Éî„ÇÇË°®Á§∫
        const uncategorizedRecipes = allRecipes.filter(recipe => recipe.categories.length === 0);
        if (uncategorizedRecipes.length > 0) {
            categoryMap.set('Êú™ÂàÜÈ°û', uncategorizedRecipes);
        }

        // HTML„ÇíÁîüÊàê
        let html = '';

        // „Ç´„ÉÜ„Ç¥„É™„Çí‰∏¶„Å≥È†Ü„Åß„ÇΩ„Éº„Éà
        const categoryOrder = ['ÂíåÈ£ü', 'Ê¥ãÈ£ü', '‰∏≠ËèØ', 'È∫∫È°û', '„Çπ„Éº„Éó', '„Çµ„É©„ÉÄ', '„Åä„Å§„Åæ„Åø', '„Éá„Ç∂„Éº„Éà', 'ÊôÇÁü≠', '„Éò„É´„Ç∑„Éº', '„Åù„ÅÆ‰ªñ', 'Êú™ÂàÜÈ°û'];
        const sortedCategories = Array.from(categoryMap.keys()).sort((a, b) => {
            const indexA = categoryOrder.indexOf(a);
            const indexB = categoryOrder.indexOf(b);
            if (indexA === -1 && indexB === -1) return a.localeCompare(b);
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });

        sortedCategories.forEach(category => {
            const recipes = categoryMap.get(category);
            const categoryIcon = getCategoryIcon(category);

            html += `
                <div class="category-section">
                    <div class="category-header">
                        <h3 class="category-title">
                            <span class="category-icon">${categoryIcon}</span>
                            ${category}
                            <span class="category-count">(${recipes.length}‰ª∂)</span>
                        </h3>
                        <a href="/recipes/category/${encodeURIComponent(category)}" class="view-all-link">
                            „Åô„Åπ„Å¶Ë°®Á§∫ ‚Üí
                        </a>
                    </div>
                    <div class="category-recipes">
            `;

            recipes.slice(0, 4).forEach(recipe => { // ÊúÄÂàù„ÅÆ4‰ª∂„ÅÆ„ÅøË°®Á§∫
                html += `
                    <div class="category-recipe-card" data-recipe-id="${recipe.id}">
                        <div class="recipe-image-wrapper">
                            <img src="${recipe.imagePath}" alt="„É¨„Ç∑„ÉîÁîªÂÉè"
                                 class="${recipe.hasImage ? 'recipe-image' : 'recipe-no-image'}" loading="lazy" />
                            <div class="recipe-overlay">
                                <h4 class="recipe-title">${recipe.title}</h4>
                                <button class="favorite-toggle-mini" data-id="${recipe.id}">
                                    <img class="heart-image-mini"
                                         src="${recipe.isFavorite ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'}"
                                         alt="„ÅäÊ∞ó„Å´ÂÖ•„Çä" />
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (recipes.length > 4) {
                html += `
                    <div class="more-recipes-card">
                        <a href="/recipes/category/${encodeURIComponent(category)}" class="more-recipes-link">
                            <div class="more-recipes-content">
                                <span class="plus-icon">+</span>
                                <span class="more-count">‰ªñ${recipes.length - 4}‰ª∂</span>
                            </div>
                        </a>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;
        });

        if (html === '') {
            html = '<p class="no-categories-message">„Ç´„ÉÜ„Ç¥„É™„ÅåË®≠ÂÆö„Åï„Çå„Åü„É¨„Ç∑„Éî„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
        }

        document.getElementById('categoriesContainer').innerHTML = html;
        document.getElementById('normalView').style.display = 'none';
        document.getElementById('categoriesView').style.display = 'block';

        // „Ç´„ÉÜ„Ç¥„É™Ë°®Á§∫Âæå„Å´„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ©üËÉΩ„ÇíÂÜç„Éê„Ç§„É≥„Éâ
        bindFavoriteTogglesMini();

    } catch (error) {
        console.error('„Ç´„ÉÜ„Ç¥„É™Ë°®Á§∫„Ç®„É©„Éº:', error);
        alert('„Ç´„ÉÜ„Ç¥„É™„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
    }
}

function hideCategoriesPage() {
    document.getElementById('categoriesView').style.display = 'none';
    document.getElementById('normalView').style.display = 'block';
}

function getCategoryIcon(category) {
    const icons = {
        'ÂíåÈ£ü': 'üç±',
        'Ê¥ãÈ£ü': 'üçù',
        '‰∏≠ËèØ': 'ü•ü',
        'È∫∫È°û': 'üçú',
        '„Çπ„Éº„Éó': 'üç≤',
        '„Çµ„É©„ÉÄ': 'ü•ó',
        '„Åä„Å§„Åæ„Åø': 'üç∫',
        '„Éá„Ç∂„Éº„Éà': 'üç∞',
        'ÊôÇÁü≠': '‚è∞',
        '„Éò„É´„Ç∑„Éº': 'ü•¨',
        '„Åù„ÅÆ‰ªñ': 'üìù',
        'Êú™ÂàÜÈ°û': 'üìÑ'
    };
    return icons[category] || 'üìù';
}

// „Ç´„ÉÜ„Ç¥„É™„Éö„Éº„Ç∏„Åß„ÅÆ„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ©üËÉΩ
function bindFavoriteTogglesMini() {
    document.querySelectorAll(".favorite-toggle-mini").forEach(button => {
        button.addEventListener("click", async (event) => {
            event.preventDefault();
            event.stopPropagation();

            const recipeId = button.getAttribute("data-id");

            try {
                const response = await fetch(`/recipes/${recipeId}/toggleFavorite`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error("„ÅäÊ∞ó„Å´ÂÖ•„ÇäÂàá„ÇäÊõø„ÅàÂ§±Êïó HTTP: " + response.status);
                }

                const isFavorite = await response.json();
                const img = button.querySelector("img");
                img.src = isFavorite ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";

            } catch (error) {
                console.error("Toggle Favorite Error:", error);
                alert("„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        });
    });
}

// „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë°®Á§∫
function showUserInfo() {
    const userInfo = `
        <div class="user-stats">
            <h4>üìä Áµ±Ë®àÊÉÖÂ†±</h4>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number">${document.querySelectorAll('.card').length}</span>
                    <span class="stat-label">Á∑è„É¨„Ç∑„ÉîÊï∞</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${document.querySelectorAll('.card .heart-image[src*="heart_active"]').length}</span>
                    <span class="stat-label">„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊï∞</span>
                </div>
            </div>
            <h4>üë§ „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±</h4>
            <p><strong>„É¶„Éº„Ç∂„ÉºÂêç:</strong> ${document.querySelector('.user-info span') ? document.querySelector('.user-info span').textContent.replace('„Çà„ÅÜ„Åì„Åù„ÄÅ', '').replace('„Åï„Çì', '') : '„Ç≤„Çπ„Éà'}</p>
            <p><strong>ÁôªÈå≤Êó•:</strong> 2024Âπ¥</p>
        </div>
    `;
    showModal('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±', userInfo);
}

// „Éò„É´„ÉóË°®Á§∫
function showHelp() {
    const helpContent = `
        <div class="help-content">
            <h4>üìñ Recipin'„ÅÆ‰Ωø„ÅÑÊñπ</h4>
            <div class="help-section">
                <h5>üÜï „É¨„Ç∑„Éî„ÅÆËøΩÂä†</h5>
                <p>Âè≥‰∏ä„ÅÆ„ÄåËøΩÂä†„Äç„Éú„Çø„É≥„Åã„Çâ„É¨„Ç∑„Éî„ÇíÊñ∞Ë¶è‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ</p>
            </div>
            <div class="help-section">
                <h5>üîç Ê§úÁ¥¢Ê©üËÉΩ</h5>
                <p>Ê§úÁ¥¢„Éê„Éº„Åß„É¨„Ç∑„ÉîÂêç„ÇÑ„Ç´„ÉÜ„Ç¥„É™„ÅßÁµû„ÇäËæº„ÅøÊ§úÁ¥¢„Åå„Åß„Åç„Åæ„Åô„ÄÇ</p>
            </div>
            <div class="help-section">
                <h5>‚ù§Ô∏è „ÅäÊ∞ó„Å´ÂÖ•„Çä</h5>
                <p>„É¨„Ç∑„Éî„Ç´„Éº„Éâ„ÅÆ„Éè„Éº„Éà„Ç¢„Ç§„Ç≥„É≥„Åß„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ</p>
            </div>
            <div class="help-section">
                <h5>üè∑Ô∏è „Ç´„ÉÜ„Ç¥„É™</h5>
                <p>„Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Äå„Ç´„ÉÜ„Ç¥„É™‰∏ÄË¶ß„Äç„Åã„Çâ„Ç´„ÉÜ„Ç¥„É™Âà•„Å´„É¨„Ç∑„Éî„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô„ÄÇ„É¨„Ç∑„Éî‰ΩúÊàêÊôÇ„ÅØ„Ç´„ÉÜ„Ç¥„É™„ÇíÊúÄÂ§ß2„Å§„Åæ„ÅßÈÅ∏ÊäûÂèØËÉΩ„Åß„Åô„ÄÇ</p>
            </div>
            <div class="help-section">
                <h5>‚úèÔ∏è Á∑®ÈõÜ„ÉªÂâäÈô§</h5>
                <p>„É¨„Ç∑„Éî„Ç´„Éº„Éâ„ÅÆ„Äå‚ãÆ„Äç„É°„Éã„É•„Éº„Åã„ÇâÁ∑®ÈõÜ„ÉªÂâäÈô§„Åå„Åß„Åç„Åæ„Åô„ÄÇ</p>
            </div>
        </div>
    `;
    showModal('„Éò„É´„Éó', helpContent);
}

// Ë®≠ÂÆöË°®Á§∫Ôºà„Çπ„Ç§„ÉÉ„ÉÅÂºèÔºâ
function showSettings() {
    const settingsContent = `
        <div class="settings-content">
            <h4>‚öôÔ∏è Ë®≠ÂÆö</h4>
            <div class="settings-section">
                <h5>üé® Ë°®Á§∫Ë®≠ÂÆö</h5>
                <div class="setting-item">
                    <span>„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</span>
                    <label class="switch">
                        <input type="checkbox" id="darkMode" onchange="toggleDarkMode()">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫</span>
                    <label class="switch">
                        <input type="checkbox" id="compactView" onchange="toggleCompactView()">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div class="settings-section">
                <h5>üìä „Éá„Éº„ÇøÁÆ°ÁêÜ</h5>
                <button class="settings-btn" onclick="exportData()">üì• „Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                <button class="settings-btn danger" onclick="confirmDataReset()">üóëÔ∏è ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà</button>
            </div>
            <div class="settings-section">
                <h5>‚ÑπÔ∏è „Ç¢„Éó„É™ÊÉÖÂ†±</h5>
                <p><strong>„Éê„Éº„Ç∏„Éß„É≥:</strong> 1.0.0</p>
                <p><strong>ÊúÄÁµÇÊõ¥Êñ∞:</strong> 2024Âπ¥</p>
            </div>
        </div>
    `;
    showModal('Ë®≠ÂÆö', settingsContent);

    // Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
    setTimeout(() => {
        loadSettingsInModal();
    }, 100);
}

// „É¢„Éº„ÉÄ„É´Ë°®Á§∫
function showModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modalOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden'; // „Çπ„ÇØ„É≠„Éº„É´ÁÑ°ÂäπÂåñ
}

// „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
    document.body.style.overflow = 'auto'; // „Çπ„ÇØ„É≠„Éº„É´ÊúâÂäπÂåñ
}

// Ë®≠ÂÆöÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
function toggleDarkMode() {
    const checkbox = document.getElementById('darkMode');
    const isDark = checkbox ? checkbox.checked : !document.body.classList.contains('dark-mode');

    if (isDark) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'true');
    } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'false');
    }

    darkModeManager.broadcastChange();
}

function toggleCompactView() {
    const checkbox = document.getElementById('compactView');
    const isCompact = checkbox ? checkbox.checked : !document.querySelector('.card-list')?.classList.contains('compact-view');
    const cardList = document.querySelector('.card-list');

    if (isCompact && cardList) {
        cardList.classList.add('compact-view');
        localStorage.setItem('compactView', 'true');
    } else if (cardList) {
        cardList.classList.remove('compact-view');
        localStorage.setItem('compactView', 'false');
    }
}

// Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„ÅÆË®≠ÂÆöË™≠„ÅøËæº„Åø
function loadSettingsInModal() {
    const darkModeCheckbox = document.getElementById('darkMode');
    const compactViewCheckbox = document.getElementById('compactView');

    if (darkModeCheckbox) {
        darkModeCheckbox.checked = localStorage.getItem('darkMode') === 'true';
    }
    if (compactViewCheckbox) {
        compactViewCheckbox.checked = localStorage.getItem('compactView') === 'true';
    }
}

function exportData() {
    // „É¨„Ç∑„Éî„Éá„Éº„Çø„ÅÆÁ∞°Êòì„Ç®„ÇØ„Çπ„Éù„Éº„Éà
    const recipes = Array.from(document.querySelectorAll('.card')).map(card => {
        const title = card.querySelector('.overlay-title')?.textContent || '';
        const categories = Array.from(card.querySelectorAll('.category-tag')).map(tag => tag.textContent);
        const isFavorite = card.querySelector('.heart-image')?.src.includes('heart_active') || false;
        return { title, categories, isFavorite };
    });

    const dataStr = JSON.stringify(recipes, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);

    const link = document.createElement('a');
    link.href = url;
    link.download = 'recipes-export.json';
    link.click();

    URL.revokeObjectURL(url);
    alert('„É¨„Ç∑„Éî„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ');
}

function confirmDataReset() {
    if (confirm('‚ö†Ô∏è Ë≠¶Âëä\n\nÂÖ®„Å¶„ÅÆ„É¨„Ç∑„Éî„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åô„Åì„Å®„Åå„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n\nÊú¨ÂΩì„Å´ÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü')) {
        if (confirm('ÊúÄÁµÇÁ¢∫Ë™çÔºöÊú¨ÂΩì„Å´ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
            // ÂÆüÈöõ„ÅÆÂâäÈô§Âá¶ÁêÜ„ÅØ„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßÂÆüË£Ö„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô
            alert('„Éá„Éº„Çø„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ„ÅØÁèæÂú®ÈñãÁô∫‰∏≠„Åß„Åô„ÄÇ');
        }
    }
}

// „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
document.addEventListener('click', function (e) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.sidebar-toggle');
    const closeBtn = document.querySelector('.sidebar-close');
    const sidebarContent = document.querySelector('.sidebar-content');

    // „É¢„Éê„Ç§„É´„Çµ„Ç§„Ç∫„Åß„ÅÆ„ÅøÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„Åß„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
    if (window.innerWidth <= 768) {
        if (!sidebarContent.contains(e.target) &&
            !toggleBtn.contains(e.target) &&
            !closeBtn.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    }

    // „É¢„Éº„ÉÄ„É´Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    if (e.target.id === 'modalOverlay') {
        closeModal();
    }
});

// ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„Éª„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        const modal = document.getElementById('modalOverlay');

        if (modal.style.display === 'flex') {
            closeModal();
        } else if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    }
});

// ÁîªÈù¢„Çµ„Ç§„Ç∫Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
window.addEventListener('resize', checkScreenSize);

// „Ç´„Éº„Éâ„É°„Éã„É•„ÉºÊ©üËÉΩ
document.addEventListener('click', function(event) {
    const menuToggles = document.querySelectorAll('.menu-toggle');
    const menuContents = document.querySelectorAll('.menu-content');

    // „É°„Éã„É•„Éº„Éà„Ç∞„É´„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà
    if (event.target.classList.contains('menu-toggle')) {
        event.stopPropagation();

        // ‰ªñ„ÅÆ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
        menuContents.forEach(menu => {
            if (menu !== event.target.nextElementSibling) {
                menu.style.display = 'none';
            }
        });

        // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„É°„Éã„É•„Éº„Çí„Éà„Ç∞„É´
        const menuContent = event.target.nextElementSibling;
        if (menuContent.style.display === 'flex') {
            menuContent.style.display = 'none';
        } else {
            menuContent.style.display = 'flex';
        }
    } else {
        // „É°„Éã„É•„Éº‰ª•Â§ñ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÅØÂÖ®„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
        menuContents.forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

// „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éà„Ç∞„É´Âá¶ÁêÜ
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".favorite-toggle").forEach(button => {
        button.addEventListener("click", async (event) => {
            event.preventDefault();

            const recipeId = button.getAttribute("data-id");

            try {
                const response = await fetch(`/recipes/${recipeId}/toggleFavorite`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error("„ÅäÊ∞ó„Å´ÂÖ•„ÇäÂàá„ÇäÊõø„ÅàÂ§±Êïó HTTP: " + response.status);
                }

                const isFavorite = await response.json();
                const img = button.querySelector("img");
                img.src = isFavorite ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";

                // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£: aria-label „ÅÆÊõ¥Êñ∞
                button.setAttribute('aria-label',
                    isFavorite ? '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§' : '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†'
                );

            } catch (error) {
                console.error("Toggle Favorite Error:", error);
                alert("„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        });
    });
});

// ÂâäÈô§„Éú„Çø„É≥Âá¶ÁêÜÔºàÊîπÂñÑÁâàÔºâ
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".delete-button").forEach(button => {
        button.addEventListener("click", async (event) => {
            event.preventDefault();

            const recipeId = button.getAttribute("data-recipe-id");
            const cardElement = document.querySelector(`[data-recipe-id="${recipeId}"]`);
            const recipeName = cardElement ? cardElement.querySelector('.overlay-title').textContent : '„Åì„ÅÆ„É¨„Ç∑„Éî';

            if (!confirm(`„Äå${recipeName}„Äç„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                return;
            }

            // ÂâäÈô§‰∏≠„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            const originalText = button.textContent;
            button.textContent = 'ÂâäÈô§‰∏≠...';
            button.disabled = true;

            try {
                const response = await fetch(`/recipes/${recipeId}/delete`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü HTTP: " + response.status);
                }

                // ÂâäÈô§ÊàêÂäüÊôÇ„ÄÅ„Ç´„Éº„Éâ„ÇíDOM„Åã„ÇâÂâäÈô§
                if (cardElement) {
                    cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    cardElement.style.opacity = '0';
                    cardElement.style.transform = 'scale(0.95)';

                    setTimeout(() => {
                        cardElement.remove();

                        // „Ç´„Éº„Éâ„Åå0‰ª∂„Å´„Å™„Å£„ÅüÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                        const remainingCards = document.querySelectorAll('.card[style*="display: none"], .card:not([style*="display: none"])');
                        const visibleCards = Array.from(remainingCards).filter(card =>
                            !card.style.display || card.style.display !== 'none'
                        );

                        if (visibleCards.length === 0) {
                            const cardList = document.querySelector('.card-list');
                            if (cardList) {
                                cardList.style.display = 'none';
                            }

                            // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
                            if (!document.querySelector('.no-recipes-message')) {
                                const noRecipeMessage = document.createElement('p');
                                noRecipeMessage.className = 'no-recipes-message';
                                noRecipeMessage.textContent = '„É¨„Ç∑„Éî„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                                document.querySelector('.main-content').appendChild(noRecipeMessage);
                            }
                        }

                        // ‰ª∂Êï∞Ë°®Á§∫„ÅÆÊõ¥Êñ∞
                        updateRecipeCount();
                    }, 300);
                }

            } catch (error) {
                console.error("Delete Recipe Error:", error);
                alert("„É¨„Ç∑„Éî„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ");

                // „Ç®„É©„ÉºÊôÇ„ÅØ„Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                button.textContent = originalText;
                button.disabled = false;
            }
        });
    });
});

// ‰ª∂Êï∞Ë°®Á§∫„ÅÆÊõ¥Êñ∞
function updateRecipeCount() {
    const visibleCards = document.querySelectorAll('.card:not([style*="display: none"])');
    const sectionTitle = document.querySelector('.section-title h2');

    if (sectionTitle) {
        const titleText = sectionTitle.textContent;
        const countMatch = titleText.match(/\((\d+)‰ª∂\)/);

        if (countMatch) {
            const newTitle = titleText.replace(/\(\d+‰ª∂\)/, `(${visibleCards.length}‰ª∂)`);
            sectionTitle.textContent = newTitle;
        }
    }
}

// Ê§úÁ¥¢Ê©üËÉΩ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
if (searchInput) {
    // Enter„Ç≠„Éº„Åß„ÅÆÊ§úÁ¥¢ÂÆüË°å
    searchInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            performSearch();
        }
    });

    // „É™„Ç¢„É´„Çø„Ç§„É†Ê§úÁ¥¢ÔºàÂÖ•Âäõ‰∏≠Ôºâ
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSearch();
        }, 300); // 300msÂæå„Å´Ê§úÁ¥¢ÂÆüË°åÔºàÈÄ£Á∂öÂÖ•ÂäõÊôÇ„ÅÆ„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏äÔºâ
    });
}

// „É≠„Éº„Éá„Ç£„É≥„Ç∞Ê©üËÉΩ
window.addEventListener('load', () => {
    const loader = document.getElementById('loading');
    const url = new URL(window.location.href);
    const hasLoadingParam = url.searchParams.get('loading') === 'true';

    if (hasLoadingParam) {
        if (loader) {
            loader.style.display = 'flex';

            setTimeout(() => {
                loader.style.display = 'none';
            }, 1500);

            // loading=true „ÇíÂâäÈô§ÔºàÂ±•Ê≠¥„ÅØÊÆã„Åô„ÅåÁîªÈù¢„ÅØ„É™„É≠„Éº„Éâ„Åó„Å™„ÅÑÔºâ
            url.searchParams.delete('loading');
            window.history.replaceState({}, document.title, url.toString());
        }
    } else {
        if (loader) {
            loader.remove(); // ‰∫åÂ∫¶ÁõÆ‰ª•Èôç„ÅØDOM„Åî„Å®ÂâäÈô§Ôºà„Å°„Çâ„Å§„ÅçÈò≤Ê≠¢Ôºâ
        }
    }
});

// „Éï„É©„ÉÉ„Ç∑„É•„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆËá™ÂãïÈùûË°®Á§∫
document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÊúüÂåñÂá¶ÁêÜ
    checkScreenSize();

    // „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâË®≠ÂÆö„ÇíÊúÄÂàù„Å´Ë™≠„ÅøËæº„Åø
    darkModeManager.loadSettings();

    // „Éï„É©„ÉÉ„Ç∑„É•„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆËá™ÂãïÈùûË°®Á§∫
    const flashMessages = document.querySelectorAll('.flash-message');
    flashMessages.forEach(message => {
        setTimeout(() => {
            message.style.opacity = '0';
            message.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 300);
        }, 4000); // 4ÁßíÂæå„Å´ÈùûË°®Á§∫
    });
});

// „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ: ÁîªÂÉè„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„ÅøÂØæÂøú
if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    observer.unobserve(img);
                }
            }
        });
    });

    // Êó¢Â≠ò„ÅÆ loading="lazy" Â±ûÊÄß„ÅÆ„ÅÇ„ÇãÁîªÂÉè„ÇíÂØæË±°„Å´
    document.querySelectorAll('img[loading="lazy"]').forEach(img => {
        imageObserver.observe(img);
    });
}
</script>
<script src="/assets/js/sidebar-active.js"></script>
</body>
</html>
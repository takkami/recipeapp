<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipin'</title>
    <meta name="description" content="sample text">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/sanitize.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="page-home">

<section id="loading">
    <div class="loading">
        <div class="pack"></div>
        <div class="fuels">
            <div></div><div></div><div></div><div></div>
        </div>
    </div>
</section>

<div class="container">
    <!-- Top Navbar -->
    <header class="top-navbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
            <span></span>
        </button>
        <div class="title">Recipin'</div>
        <div class="header-right">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ -->
            <div class="user-info" sec:authorize="isAuthenticated()">
                <span th:text="'ã‚ˆã†ã“ãã€' + ${#authentication.name} + 'ã•ã‚“'">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
            </div>
            <div class="header-actions" sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </form>
            </div>

        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹">
                    âœ•
                </button>
            </div>
            <ul>
                <li>
                    <a href="/home" class="home-button">
                        <img src="/images/icons/home.svg" alt="ãƒ›ãƒ¼ãƒ " />
                        <span>ãƒ›ãƒ¼ãƒ </span>
                    </a>
                </li>
                <li>
                    <a href="/recipes/random">
                        <img src="/images/icons/random.svg" alt="ãƒ©ãƒ³ãƒ€ãƒ ãƒ¬ã‚·ãƒ”" />
                        <span>ãƒ©ãƒ³ãƒ€ãƒ ãƒ¬ã‚·ãƒ”</span>
                    </a>
                </li>
                <li>
                    <a href="/recipes/favorites">
                        <img src="/images/icons/heart.svg" alt="ãŠæ°—ã«å…¥ã‚Š">
                        <span>ãŠæ°—ã«å…¥ã‚Š</span>
                    </a>
                </li>
                <li>
                    <div class="menu-item" onclick="showCategoriesPage()">
                        <img src="/images/icons/category.svg" alt="ã‚«ãƒ†ã‚´ãƒª" />
                        <span>ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</span>
                    </div>
                </li>
                <li>
                    <div class="menu-item" onclick="showUserInfo()">
                        <img src="/images/icons/user.svg" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±" />
                        <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</span>
                    </div>
                </li>
                <li>
                    <div class="menu-item" onclick="showHelp()">
                        <img src="/images/icons/interrogation.svg" alt="ãƒ˜ãƒ«ãƒ—" />
                        <span>ãƒ˜ãƒ«ãƒ—</span>
                    </div>
                </li>
                <li class="bottom">
                    <div class="menu-item" onclick="showSettings()">
                        <img src="/images/icons/settings.svg" alt="è¨­å®š" />
                        <span>è¨­å®š</span>
                    </div>
                </li>
                <li class="bottom" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" style="margin:0;">
                        <button type="submit" class="logout-sidebar-btn">
                            <img src="/images/icons/logout.svg" alt="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" />
                            <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="main-toolbar">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="ãƒ¬ã‚·ãƒ”åã‚„ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢..." />
                <span class="search-icon">
                <img src="/images/icons/search.svg" alt="æ¤œç´¢" />
              </span>
            </div>
            <div class="add-button-container">
                <a href="/recipes/new" class="add-button">
                    <span class="add-text">è¿½åŠ </span>
                    <img src="/images/icons/add.svg" alt="è¿½åŠ ">
                </a>
            </div>
        </div>

        <!-- é€šå¸¸ã®ãƒ¬ã‚·ãƒ”è¡¨ç¤º -->
        <div id="normalView">
            <div class="section-header">
                <div class="section-title">
                    <h2 th:if="${favoritesPage != null and favoritesPage}" th:text="'ãŠæ°—ã«å…¥ã‚Šãƒ¬ã‚·ãƒ”ä¸€è¦§ (' + ${#lists.size(recipes)} + 'ä»¶)'">ãŠæ°—ã«å…¥ã‚Š</h2>
                    <h2 th:if="${randomPage != null and randomPage}" th:text="'ãƒ©ãƒ³ãƒ€ãƒ ãƒ¬ã‚·ãƒ”'">ãƒ©ãƒ³ãƒ€ãƒ ãƒ¬ã‚·ãƒ”</h2>
                    <h2 th:if="${categoryName != null}" th:text="'ã‚«ãƒ†ã‚´ãƒªï¼š' + ${categoryName} + ' (' + ${#lists.size(recipes)} + 'ä»¶)'">ã‚«ãƒ†ã‚´ãƒª</h2>
                    <h2 th:if="${favoritesPage == null and randomPage == null and categoryName == null}" th:text="'ã™ã¹ã¦ã®ãƒ¬ã‚·ãƒ”ä¸€è¦§ (' + ${#lists.size(recipes)} + 'ä»¶)'">ã™ã¹ã¦ã®ãƒ¬ã‚·ãƒ”</h2>
                </div>
                <div th:if="${randomPage != null and randomPage}" class="add-button-container">
                    <a href="/recipes/random" class="add-button" onclick="showRandomLoadingEffect(event)">
                        <span class="add-text">åˆ¥ã®ãƒ¬ã‚·ãƒ”</span>
                        <img src="/images/icons/random.svg" alt="ãƒ©ãƒ³ãƒ€ãƒ ">
                    </a>
                </div>
            </div>

            <!-- æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
            <div th:if="${successMessage}" class="flash-message success-message">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="flash-message error-message">
                <span th:text="${errorMessage}"></span>
            </div>

            <p th:if="${#lists.isEmpty(recipes)}" class="no-recipes-message">ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            <p id="noResultsMessage" class="no-results-message" style="display: none;">æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>

            <!-- ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div class="card-list" th:if="${not #lists.isEmpty(recipes)}">
                <section class="card" th:each="recipe : ${recipes}" th:attr="data-recipe-id=${recipe.id}, data-reference=${recipe.reference}">
                    <div class="card-menu">
                        <button class="menu-toggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">ï¸™</button>
                        <div class="menu-content">
                            <form th:action="@{'/recipes/edit/' + ${recipe.id}}" method="get" style="margin:0;">
                                <button type="submit" class="edit-button">ç·¨é›†</button>
                            </form>
                            <button type="button" class="delete-button" th:attr="data-recipe-id=${recipe.id}">å‰Šé™¤</button>
                        </div>
                    </div>
                    <div class="card-image-wrapper clickable-card" onclick="handleCardClick(event)">
                        <img th:if="${recipe.imagePath != null}" th:src="@{${recipe.imagePath}}" alt="ãƒ¬ã‚·ãƒ”ç”»åƒ" class="card-image" loading="lazy" />
                        <img th:if="${recipe.imagePath == null}" th:src="@{/images/no-image.png}" alt="ãƒ¬ã‚·ãƒ”ç”»åƒãªã—" class="card-no-image" loading="lazy" />
                        <div class="card-overlay">
                            <h2 th:text="${recipe.title}" class="overlay-title">ãƒ¬ã‚·ãƒ”å</h2>
                            <button class="favorite-toggle" th:attr="data-id=${recipe.id}" aria-label="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ">
                                <img class="heart-image" th:src="${recipe.favorite} ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'" alt="ãŠæ°—ã«å…¥ã‚Š" />
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                      <span th:each="cat : ${recipe.categories}">
                         <a th:href="@{'/recipes/category/' + ${cat}}"
                            th:text="${cat}"
                            th:classappend="'category-tag ' + ${cat}"
                            title="ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ¬ã‚·ãƒ”ã‚’è¡¨ç¤º">
                            ã‚«ãƒ†ã‚´ãƒª
                        </a>
                      </span>
                    </div>
                </section>
            </div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥è¡¨ç¤ºãƒ“ãƒ¥ãƒ¼ -->
        <div id="categoriesView" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <h2>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ¬ã‚·ãƒ”ä¸€è¦§</h2>
                </div>
                <button class="back-button" onclick="hideCategoriesPage()">
                    <span>â† æˆ»ã‚‹</span>
                </button>
            </div>
            <div id="categoriesContainer">
                <!-- å‹•çš„ã«ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ¬ã‚·ãƒ”ãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
        </div>
    </main>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="modalOverlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- å‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
        </div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†ã‚¯ãƒ©ã‚¹
class DarkModeManager {
    constructor() {
        this.init();
    }

    init() {
        // åˆæœŸè¨­å®šã®èª­ã¿è¾¼ã¿
        this.loadSettings();
        // è¨­å®šå¤‰æ›´ã®ç›£è¦–
        this.watchStorageChanges();
    }

    loadSettings() {
        const darkMode = localStorage.getItem('darkMode') === 'true';
        const compactView = localStorage.getItem('compactView') === 'true';

        if (darkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }

        if (compactView) {
            document.querySelector('.card-list')?.classList.add('compact-view');
        }
    }

    toggle() {
        const isDark = document.body.classList.contains('dark-mode');
        if (isDark) {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'false');
        } else {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'true');
        }

        // ä»–ã®ã‚¿ãƒ–/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«å¤‰æ›´ã‚’é€šçŸ¥
        this.broadcastChange();
    }

    watchStorageChanges() {
        // localStorage ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆä»–ã®ã‚¿ãƒ–ã‹ã‚‰ã®å¤‰æ›´ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'darkMode') {
                this.loadSettings();
            }
        });

        // åŒä¸€ã‚¿ãƒ–å†…ã§ã®å¤‰æ›´ã‚’ç›£è¦–
        window.addEventListener('darkmodechange', () => {
            this.loadSettings();
        });
    }

    broadcastChange() {
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ï¼ˆåŒä¸€ã‚¿ãƒ–å†…ï¼‰
        window.dispatchEvent(new Event('darkmodechange'));
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const darkModeManager = new DarkModeManager();

// ãƒ©ãƒ³ãƒ€ãƒ ãƒ¬ã‚·ãƒ”ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åŠ¹æœ
function showRandomLoadingEffect(event) {
    event.preventDefault();

    const button = event.currentTarget;
    const originalText = button.querySelector('.add-text').textContent;

    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
    button.querySelector('.add-text').textContent = 'é¸æŠä¸­...';
    button.style.opacity = '0.7';
    button.style.pointerEvents = 'none';

    // çŸ­æ™‚é–“ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¼”å‡ºå¾Œã«ãƒšãƒ¼ã‚¸é·ç§»
    setTimeout(() => {
        window.location.href = '/recipes/random';
    }, 500);
}

// æ¤œç´¢æ©Ÿèƒ½ã®æ”¹å–„
const searchInput = document.getElementById('searchInput');
const recipeCards = document.querySelectorAll('.card');

// æ­£è¦åŒ–é–¢æ•°ï¼ˆã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãªã€å°æ–‡å­—åŒ–ã€å…¨è§’â†’åŠè§’ï¼‰
function normalizeText(str) {
  return str
    .toLowerCase()
    .normalize("NFKC")
    .replace(/[ã‚¡-ãƒ³]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60));
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢æ©Ÿèƒ½
function performSearch() {
    const keywordRaw = searchInput.value.trim();
    const keyword = normalizeText(keywordRaw);

    const noResultsMessage = document.getElementById('noResultsMessage');
    const noRecipesMessage = document.querySelector('.no-recipes-message');
    let visibleCardCount = 0;

    // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã¯å…¨ã¦è¡¨ç¤º
    if (keyword === '') {
        recipeCards.forEach(card => {
            card.style.display = '';
            visibleCardCount++;
        });
        noResultsMessage.style.display = 'none';
        return;
    }

    recipeCards.forEach(card => {
        const titleElement = card.querySelector('h2');
        const categoryElements = card.querySelectorAll('.category-tag');

        const title = normalizeText(titleElement ? titleElement.textContent : '');
        const categories = Array.from(categoryElements).map(el =>
            normalizeText(el ? el.textContent : '')
        ).join(' ');

        const titleMatch = title.includes(keyword);
        const categoryMatch = categories.includes(keyword);

        if (titleMatch || categoryMatch) {
            card.style.display = '';
            visibleCardCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // æ¤œç´¢çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºåˆ¶å¾¡
    if (visibleCardCount === 0) {
        noResultsMessage.style.display = 'block';
        if (noRecipesMessage) {
            noRecipesMessage.style.display = 'none';
        }
    } else {
        noResultsMessage.style.display = 'none';
    }
}

// ã‚µã‚¤ãƒ‰ãƒãƒ¼æ©Ÿèƒ½
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
}

function checkScreenSize() {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.sidebar-toggle');

    if (window.innerWidth > 768) {
        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚µã‚¤ã‚ºã®å ´åˆã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
        sidebar.classList.remove('active');
    }
}

// ã‚«ãƒ†ã‚´ãƒªåˆ¥è¡¨ç¤ºæ©Ÿèƒ½
async function showCategoriesPage() {
    try {
        // å…¨ãƒ¬ã‚·ãƒ”ã‚’å–å¾—
        const allRecipes = Array.from(document.querySelectorAll('.card')).map(card => {
            const titleElement = card.querySelector('.overlay-title');
            const categoryElements = card.querySelectorAll('.category-tag');
            const heartImage = card.querySelector('.heart-image');
            const recipeImage = card.querySelector('.card-image, .card-no-image');

            return {
                id: card.getAttribute('data-recipe-id'),
                title: titleElement ? titleElement.textContent : '',
                categories: Array.from(categoryElements).map(el => el.textContent.trim()),
                isFavorite: heartImage ? heartImage.src.includes('heart_active') : false,
                imagePath: recipeImage ? recipeImage.src : '',
                hasImage: recipeImage ? !recipeImage.src.includes('no-image') : false,
                reference: card.getAttribute('data-reference') || ''
            };
        });

        // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ãƒ¬ã‚·ãƒ”ã‚’åˆ†é¡
        const categoryMap = new Map();

        allRecipes.forEach(recipe => {
            recipe.categories.forEach(category => {
                if (!categoryMap.has(category)) {
                    categoryMap.set(category, []);
                }
                categoryMap.get(category).push(recipe);
            });
        });

        // ã‚«ãƒ†ã‚´ãƒªãŒãªã„ãƒ¬ã‚·ãƒ”ã‚‚è¡¨ç¤º
        const uncategorizedRecipes = allRecipes.filter(recipe => recipe.categories.length === 0);
        if (uncategorizedRecipes.length > 0) {
            categoryMap.set('æœªåˆ†é¡', uncategorizedRecipes);
        }

        // HTMLã‚’ç”Ÿæˆ
        let html = '';

        // ã‚«ãƒ†ã‚´ãƒªã‚’ä¸¦ã³é †ã§ã‚½ãƒ¼ãƒˆ
        const categoryOrder = ['å’Œé£Ÿ', 'æ´‹é£Ÿ', 'ä¸­è¯', 'éººé¡', 'ã‚¹ãƒ¼ãƒ—', 'ã‚µãƒ©ãƒ€', 'ãŠã¤ã¾ã¿', 'ãƒ‡ã‚¶ãƒ¼ãƒˆ', 'æ™‚çŸ­', 'ãƒ˜ãƒ«ã‚·ãƒ¼', 'ãã®ä»–', 'æœªåˆ†é¡'];
        const sortedCategories = Array.from(categoryMap.keys()).sort((a, b) => {
            const indexA = categoryOrder.indexOf(a);
            const indexB = categoryOrder.indexOf(b);
            if (indexA === -1 && indexB === -1) return a.localeCompare(b);
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });

        sortedCategories.forEach(category => {
            const recipes = categoryMap.get(category);
            const categoryIcon = getCategoryIcon(category);

            html += `
                <div class="category-section">
                    <div class="category-header">
                        <h3 class="category-title">
                            <span class="category-icon">${categoryIcon}</span>
                            ${category}
                            <span class="category-count">(${recipes.length}ä»¶)</span>
                        </h3>
                        <a href="/recipes/category/${encodeURIComponent(category)}" class="view-all-link">
                            ã™ã¹ã¦è¡¨ç¤º â†’
                        </a>
                    </div>
                    <div class="category-recipes">
            `;

            recipes.slice(0, 4).forEach(recipe => { // æœ€åˆã®4ä»¶ã®ã¿è¡¨ç¤º
                html += `
                    <div class="category-recipe-card clickable-card" data-recipe-id="${recipe.id}" data-reference="${recipe.reference || ''}" onclick="handleCategoryCardClick(event)">
                        <div class="recipe-image-wrapper">
                            <img src="${recipe.imagePath}" alt="ãƒ¬ã‚·ãƒ”ç”»åƒ"
                                 class="${recipe.hasImage ? 'recipe-image' : 'recipe-no-image'}" loading="lazy" />
                            <div class="recipe-overlay">
                                <h4 class="recipe-title">${recipe.title}</h4>
                                <button class="favorite-toggle-mini" data-id="${recipe.id}">
                                    <img class="heart-image-mini"
                                         src="${recipe.isFavorite ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'}"
                                         alt="ãŠæ°—ã«å…¥ã‚Š" />
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (recipes.length > 4) {
                html += `
                    <div class="more-recipes-card">
                        <a href="/recipes/category/${encodeURIComponent(category)}" class="more-recipes-link">
                            <div class="more-recipes-content">
                                <span class="plus-icon">+</span>
                                <span class="more-count">ä»–${recipes.length - 4}ä»¶</span>
                            </div>
                        </a>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;
        });

        if (html === '') {
            html = '<p class="no-categories-message">ã‚«ãƒ†ã‚´ãƒªãŒè¨­å®šã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }

        document.getElementById('categoriesContainer').innerHTML = html;
        document.getElementById('normalView').style.display = 'none';
        document.getElementById('categoriesView').style.display = 'block';

        // ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºå¾Œã«ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã‚’å†ãƒã‚¤ãƒ³ãƒ‰
        bindFavoriteTogglesMini();

    } catch (error) {
        console.error('ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
}

function hideCategoriesPage() {
    document.getElementById('categoriesView').style.display = 'none';
    document.getElementById('normalView').style.display = 'block';
}

function getCategoryIcon(category) {
    const icons = {
        'å’Œé£Ÿ': 'ğŸ±',
        'æ´‹é£Ÿ': 'ğŸ',
        'ä¸­è¯': 'ğŸ¥Ÿ',
        'éººé¡': 'ğŸœ',
        'ã‚¹ãƒ¼ãƒ—': 'ğŸ²',
        'ã‚µãƒ©ãƒ€': 'ğŸ¥—',
        'ãŠã¤ã¾ã¿': 'ğŸº',
        'ãƒ‡ã‚¶ãƒ¼ãƒˆ': 'ğŸ°',
        'æ™‚çŸ­': 'â°',
        'ãƒ˜ãƒ«ã‚·ãƒ¼': 'ğŸ¥¬',
        'ãã®ä»–': 'ğŸ“',
        'æœªåˆ†é¡': 'ğŸ“„'
    };
    return icons[category] || 'ğŸ“';
}

// ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã§ã®ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½
function bindFavoriteTogglesMini() {
    document.querySelectorAll(".favorite-toggle-mini").forEach(button => {
        button.addEventListener("click", async (event) => {
            event.preventDefault();
            event.stopPropagation();

            const recipeId = button.getAttribute("data-id");

            try {
                const response = await fetch(`/recipes/${recipeId}/toggleFavorite`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error("ãŠæ°—ã«å…¥ã‚Šåˆ‡ã‚Šæ›¿ãˆå¤±æ•— HTTP: " + response.status);
                }

                const isFavorite = await response.json();
                const img = button.querySelector("img");
                img.src = isFavorite ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";

            } catch (error) {
                console.error("Toggle Favorite Error:", error);
                alert("ãŠæ°—ã«å…¥ã‚Šã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        });
    });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
function showUserInfo() {
    const userInfo = `
        <div class="user-stats">
            <h4>ğŸ“Š çµ±è¨ˆæƒ…å ±</h4>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number">${document.querySelectorAll('.card').length}</span>
                    <span class="stat-label">ç·ãƒ¬ã‚·ãƒ”æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${document.querySelectorAll('.card .heart-image[src*="heart_active"]').length}</span>
                    <span class="stat-label">ãŠæ°—ã«å…¥ã‚Šæ•°</span>
                </div>
            </div>
            <h4>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h4>
            <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${document.querySelector('.user-info span') ? document.querySelector('.user-info span').textContent.replace('ã‚ˆã†ã“ãã€', '').replace('ã•ã‚“', '') : 'ã‚²ã‚¹ãƒˆ'}</p>
            <p><strong>ç™»éŒ²æ—¥:</strong> 2024å¹´</p>
        </div>
    `;
    showModal('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±', userInfo);
}

// ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
function showHelp() {
    const helpContent = `
        <div class="help-content">
            <h4>ğŸ“– Recipin'ã®ä½¿ã„æ–¹</h4>
            <div class="help-section">
                <h5>ğŸ†• ãƒ¬ã‚·ãƒ”ã®è¿½åŠ </h5>
                <p>å³ä¸Šã®ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ¬ã‚·ãƒ”ã‚’æ–°è¦ä½œæˆã§ãã¾ã™ã€‚</p>
            </div>
            <div class="help-section">
                <h5>ğŸ” æ¤œç´¢æ©Ÿèƒ½</h5>
                <p>æ¤œç´¢ãƒãƒ¼ã§ãƒ¬ã‚·ãƒ”åã‚„ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿æ¤œç´¢ãŒã§ãã¾ã™ã€‚æ–‡å­—ã‚’å…¥åŠ›ã—ã¦Enterã‚­ãƒ¼ã‚’æŠ¼ã™ã¨æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</p>
            </div>
            <div class="help-section">
                <h5>ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ¬ã‚·ãƒ”</h5>
                <p>ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œãƒ©ãƒ³ãƒ€ãƒ ãƒ¬ã‚·ãƒ”ã€ã§ç™»éŒ²æ¸ˆã¿ãƒ¬ã‚·ãƒ”ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚æ–™ç†ã«è¿·ã£ãŸæ™‚ã«ãŠä½¿ã„ãã ã•ã„ã€‚</p>
            </div>
            <div class="help-section">
                <h5>â¤ï¸ ãŠæ°—ã«å…¥ã‚Š</h5>
                <p>ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã®ãƒãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã§ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="help-section">
                <h5>ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª</h5>
                <p>ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã€ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ãƒ¬ã‚·ãƒ”ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚ãƒ¬ã‚·ãƒ”ä½œæˆæ™‚ã¯ã‚«ãƒ†ã‚´ãƒªã‚’æœ€å¤§2ã¤ã¾ã§é¸æŠå¯èƒ½ã§ã™ã€‚</p>
            </div>
            <div class="help-section">
                <h5>ğŸ”— å‚è€ƒURLã®æ´»ç”¨</h5>
                <p>ãƒ¬ã‚·ãƒ”ã«å‚è€ƒURLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å‚è€ƒã‚µã‚¤ãƒˆãŒåˆ¥ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚</p>
            </div>
            <div class="help-section">
                <h5>âœï¸ ç·¨é›†ãƒ»å‰Šé™¤</h5>
                <p>ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã®ã€Œâ‹®ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ç·¨é›†ãƒ»å‰Šé™¤ãŒã§ãã¾ã™ã€‚</p>
            </div>
        </div>
    `;
    showModal('ãƒ˜ãƒ«ãƒ—', helpContent);
}

// è¨­å®šè¡¨ç¤ºï¼ˆã‚¹ã‚¤ãƒƒãƒå¼ï¼‰
function showSettings() {
    const settingsContent = `
        <div class="settings-content">
            <h4>âš™ï¸ è¨­å®š</h4>
            <div class="settings-section">
                <h5>ğŸ¨ è¡¨ç¤ºè¨­å®š</h5>
                <div class="setting-item">
                    <span>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
                    <label class="switch">
                        <input type="checkbox" id="darkMode" onchange="toggleDarkMode()">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º</span>
                    <label class="switch">
                        <input type="checkbox" id="compactView" onchange="toggleCompactView()">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div class="settings-section">
                <h5>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h5>
                <button class="settings-btn" onclick="exportData()">ğŸ“„ PDFã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="settings-btn danger" onclick="confirmDataReset()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="settings-section">
                <h5>â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</h5>
                <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> 1.0.0</p>
                <p><strong>æœ€çµ‚æ›´æ–°:</strong> 2025å¹´</p>
            </div>
        </div>
    `;
    showModal('è¨­å®š', settingsContent);

    // è¨­å®šã‚’èª­ã¿è¾¼ã¿
    setTimeout(() => {
        loadSettingsInModal();
    }, 100);
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modalOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden'; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ–
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
    document.body.style.overflow = 'auto'; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ–
}

// è¨­å®šé–¢é€£ã®é–¢æ•°
function toggleDarkMode() {
    const checkbox = document.getElementById('darkMode');
    const isDark = checkbox ? checkbox.checked : !document.body.classList.contains('dark-mode');

    if (isDark) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'true');
    } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'false');
    }

    darkModeManager.broadcastChange();
}

function toggleCompactView() {
    const checkbox = document.getElementById('compactView');
    const isCompact = checkbox ? checkbox.checked : !document.querySelector('.card-list')?.classList.contains('compact-view');
    const cardList = document.querySelector('.card-list');

    if (isCompact && cardList) {
        cardList.classList.add('compact-view');
        localStorage.setItem('compactView', 'true');
    } else if (cardList) {
        cardList.classList.remove('compact-view');
        localStorage.setItem('compactView', 'false');
    }
}

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã®è¨­å®šèª­ã¿è¾¼ã¿
function loadSettingsInModal() {
    const darkModeCheckbox = document.getElementById('darkMode');
    const compactViewCheckbox = document.getElementById('compactView');

    if (darkModeCheckbox) {
        darkModeCheckbox.checked = localStorage.getItem('darkMode') === 'true';
    }
    if (compactViewCheckbox) {
        compactViewCheckbox.checked = localStorage.getItem('compactView') === 'true';
    }
}

function exportData() {
    try {
        // jsPDFã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆæ—¥æœ¬èªå¯¾å¿œã®ãŸã‚ï¼‰
        doc.setFont("helvetica");

        // PDFã®ã‚¿ã‚¤ãƒˆãƒ«
        doc.setFontSize(20);
        doc.text("Recipin' - ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿", 20, 20);

        // å‡ºåŠ›æ—¥æ™‚
        const now = new Date();
        const dateStr = now.toLocaleDateString('ja-JP') + ' ' + now.toLocaleTimeString('ja-JP');
        doc.setFontSize(10);
        doc.text("å‡ºåŠ›æ—¥æ™‚: " + dateStr, 20, 30);

        // ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã®åé›†
        const recipes = Array.from(document.querySelectorAll('.card')).map(card => {
            const title = card.querySelector('.overlay-title')?.textContent || '';
            const categories = Array.from(card.querySelectorAll('.category-tag')).map(tag => tag.textContent);
            const isFavorite = card.querySelector('.heart-image')?.src.includes('heart_active') || false;
            return { title, categories, isFavorite };
        });

        // çµ±è¨ˆæƒ…å ±
        const totalRecipes = recipes.length;
        const favoriteRecipes = recipes.filter(r => r.isFavorite).length;
        const allCategories = [...new Set(recipes.flatMap(r => r.categories))];

        doc.setFontSize(14);
        doc.text("=== çµ±è¨ˆæƒ…å ± ===", 20, 45);
        doc.setFontSize(12);
        doc.text("ç·ãƒ¬ã‚·ãƒ”æ•°: " + totalRecipes + "ä»¶", 20, 55);
        doc.text("ãŠæ°—ã«å…¥ã‚Šæ•°: " + favoriteRecipes + "ä»¶", 20, 65);
        doc.text("ä½¿ç”¨ã‚«ãƒ†ã‚´ãƒªæ•°: " + allCategories.length + "ç¨®é¡", 20, 75);

        let yPosition = 90;

        // ãƒ¬ã‚·ãƒ”ä¸€è¦§
        doc.setFontSize(14);
        doc.text("=== ãƒ¬ã‚·ãƒ”ä¸€è¦§ ===", 20, yPosition);
        yPosition += 15;

        doc.setFontSize(10);

        recipes.forEach((recipe, index) => {
            // ãƒšãƒ¼ã‚¸ãŒè¶³ã‚Šãªã„å ´åˆã¯æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ 
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }

            const recipeNumber = (index + 1).toString().padStart(3, '0');
            const favoriteIcon = recipe.isFavorite ? "[â˜…]" : "[ ]";
            const categoriesStr = recipe.categories.length > 0 ?
                "[" + recipe.categories.join(", ") + "]" : "[æœªåˆ†é¡]";

            // ãƒ¬ã‚·ãƒ”ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ–‡å­—æ•°åˆ¶é™ï¼‰
            const maxTitleLength = 35;
            const displayTitle = recipe.title.length > maxTitleLength ?
                recipe.title.substring(0, maxTitleLength) + "..." : recipe.title;

            doc.text(recipeNumber + ". " + favoriteIcon + " " + displayTitle, 20, yPosition);
            yPosition += 8;
            doc.text("     " + categoriesStr, 20, yPosition);
            yPosition += 12;
        });

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆï¼ˆæ–°ã—ã„ãƒšãƒ¼ã‚¸ï¼‰
        if (allCategories.length > 0) {
            doc.addPage();
            yPosition = 20;

            doc.setFontSize(14);
            doc.text("=== ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ ===", 20, yPosition);
            yPosition += 15;

            doc.setFontSize(10);

            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ä»¶æ•°ã‚’è¨ˆç®—
            const categoryStats = allCategories.map(category => {
                const count = recipes.filter(recipe => recipe.categories.includes(category)).length;
                return { category, count };
            }).sort((a, b) => b.count - a.count);

            categoryStats.forEach(stat => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.text(stat.category + ": " + stat.count + "ä»¶", 20, yPosition);
                yPosition += 10;
            });
        }

        // PDFãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆ
        const fileName = "Recipin_ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿_" +
            now.getFullYear() +
            String(now.getMonth() + 1).padStart(2, '0') +
            String(now.getDate()).padStart(2, '0') +
            ".pdf";

        // PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        doc.save(fileName);

        alert('âœ… PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼\n' +
              'ç·ãƒ¬ã‚·ãƒ”æ•°: ' + totalRecipes + 'ä»¶\n' +
              'ãŠæ°—ã«å…¥ã‚Š: ' + favoriteRecipes + 'ä»¶');

    } catch (error) {
        console.error('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒPDFç”Ÿæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
    }
}

// å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã®å®Ÿè£…
async function confirmDataReset() {
    if (confirm('âš ï¸ è­¦å‘Š\n\nå…¨ã¦ã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
        if (confirm('æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                const loadingMessage = document.createElement('div');
                loadingMessage.innerHTML = 'å‰Šé™¤ä¸­ã§ã™...ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
                loadingMessage.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px;
                    border-radius: 8px;
                    z-index: 9999;
                    font-size: 16px;
                    font-weight: bold;
                `;
                document.body.appendChild(loadingMessage);

                // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                // ã‚µãƒ¼ãƒãƒ¼ã«å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                const response = await fetch('/api/admin/reset-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        [csrfHeader]: csrfToken
                    },
                    credentials: 'same-origin'
                });

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
                document.body.removeChild(loadingMessage);

                if (response.ok) {
                    const message = await response.text();
                    alert('âœ… ' + message);

                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦UIã‚’æ›´æ–°
                    window.location.reload();
                } else {
                    const errorMessage = await response.text();
                    throw new Error(errorMessage);
                }

            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºå‰Šé™¤
                const loadingElement = document.querySelector('div[style*="position: fixed"]');
                if (loadingElement) {
                    document.body.removeChild(loadingElement);
                }

                console.error('ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
    }
}

// ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆå‚è€ƒURLå¯¾å¿œï¼‰
function handleCardClick(event) {
    console.log('ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ'); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

    // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
    event.stopPropagation();

    // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (event.target.closest('.favorite-toggle') ||
        event.target.closest('.menu-toggle') ||
        event.target.closest('.menu-content') ||
        event.target.closest('.category-tag')) {
        console.log('é™¤å¤–è¦ç´ ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        return;
    }

    // ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’å–å¾—
    const card = event.target.closest('.card');
    if (!card) {
        console.log('ã‚«ãƒ¼ãƒ‰è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        return;
    }

    // å‚è€ƒURLã‚’å–å¾—
    const referenceUrl = card.getAttribute('data-reference');
    console.log('å‚è€ƒURL:', referenceUrl); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

    if (referenceUrl && referenceUrl.trim() !== '' && referenceUrl.trim() !== 'null') {
        // URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€åˆ¥ã‚¿ãƒ–ã§é–‹ã
        try {
            // URLã®æ¤œè¨¼ï¼ˆåŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯ï¼‰
            let urlToOpen = referenceUrl.trim();

            // httpã¾ãŸã¯httpsã§å§‹ã¾ã‚‰ãªã„å ´åˆã¯ã€httpsã‚’è¿½åŠ 
            if (!urlToOpen.startsWith('http://') && !urlToOpen.startsWith('https://')) {
                urlToOpen = 'https://' + urlToOpen;
            }

            const url = new URL(urlToOpen);
            console.log('URLã‚’é–‹ãã¾ã™:', urlToOpen); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
            window.open(urlToOpen, '_blank', 'noopener,noreferrer');
        } catch (error) {
            console.error('URLé–‹ã‘ã¾ã›ã‚“ã‚¨ãƒ©ãƒ¼:', error); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
            // ç„¡åŠ¹ãªURLã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
            alert('å‚è€ƒURLãŒç„¡åŠ¹ã§ã™ï¼š' + referenceUrl);
        }
    } else {
        // URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const recipeTitle = card.querySelector('.overlay-title')?.textContent || 'ã“ã®ãƒ¬ã‚·ãƒ”';
        console.log('URLãŒæœªè¨­å®š:', recipeTitle); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        alert('ã€Œ' + recipeTitle + 'ã€ã«ã¯å‚è€ƒURLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    }
}

// ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã§ã®ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
function handleCategoryCardClick(event) {
    console.log('ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ'); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

    // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
    event.stopPropagation();

    // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (event.target.closest('.favorite-toggle-mini')) {
        console.log('ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        return;
    }

    // ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’å–å¾—
    const card = event.target.closest('.category-recipe-card');
    if (!card) {
        console.log('ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        return;
    }

    // å‚è€ƒURLã‚’å–å¾—
    const referenceUrl = card.getAttribute('data-reference');
    console.log('ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰å‚è€ƒURL:', referenceUrl); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

    if (referenceUrl && referenceUrl.trim() !== '' && referenceUrl.trim() !== 'null') {
        // URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€åˆ¥ã‚¿ãƒ–ã§é–‹ã
        try {
            let urlToOpen = referenceUrl.trim();

            if (!urlToOpen.startsWith('http://') && !urlToOpen.startsWith('https://')) {
                urlToOpen = 'https://' + urlToOpen;
            }

            const url = new URL(urlToOpen);
            console.log('ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰URLã‚’é–‹ãã¾ã™:', urlToOpen); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
            window.open(urlToOpen, '_blank', 'noopener,noreferrer');
        } catch (error) {
            console.error('ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰URLé–‹ã‘ã¾ã›ã‚“ã‚¨ãƒ©ãƒ¼:', error); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
            alert('å‚è€ƒURLãŒç„¡åŠ¹ã§ã™ï¼š' + referenceUrl);
        }
    } else {
        // URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const recipeTitle = card.querySelector('.recipe-title')?.textContent || 'ã“ã®ãƒ¬ã‚·ãƒ”';
        console.log('ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰URLãŒæœªè¨­å®š:', recipeTitle); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        alert('ã€Œ' + recipeTitle + 'ã€ã«ã¯å‚è€ƒURLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
document.addEventListener('click', function (e) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.sidebar-toggle');
    const closeBtn = document.querySelector('.sidebar-close');
    const sidebarContent = document.querySelector('.sidebar-content');

    // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã§ã®ã¿å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
    if (window.innerWidth <= 768) {
        if (!sidebarContent.contains(e.target) &&
            !toggleBtn.contains(e.target) &&
            !closeBtn.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    if (e.target.id === 'modalOverlay') {
        closeModal();
    }
});

// ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        const modal = document.getElementById('modalOverlay');

        if (modal.style.display === 'flex') {
            closeModal();
        } else if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    }
});

// ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
window.addEventListener('resize', checkScreenSize);

// ã‚«ãƒ¼ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½
document.addEventListener('click', function(event) {
    const menuToggles = document.querySelectorAll('.menu-toggle');
    const menuContents = document.querySelectorAll('.menu-content');

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒˆã‚°ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
    if (event.target.classList.contains('menu-toggle')) {
        event.stopPropagation();

        // ä»–ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        menuContents.forEach(menu => {
            if (menu !== event.target.nextElementSibling) {
                menu.style.display = 'none';
            }
        });

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒˆã‚°ãƒ«
        const menuContent = event.target.nextElementSibling;
        if (menuContent.style.display === 'flex') {
            menuContent.style.display = 'none';
        } else {
            menuContent.style.display = 'flex';
        }
    } else {
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä»¥å¤–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        menuContents.forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

// ãŠæ°—ã«å…¥ã‚Šãƒˆã‚°ãƒ«å‡¦ç†
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".favorite-toggle").forEach(button => {
        button.addEventListener("click", async (event) => {
            event.preventDefault();

            const recipeId = button.getAttribute("data-id");

            try {
                const response = await fetch(`/recipes/${recipeId}/toggleFavorite`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error("ãŠæ°—ã«å…¥ã‚Šåˆ‡ã‚Šæ›¿ãˆå¤±æ•— HTTP: " + response.status);
                }

                const isFavorite = await response.json();
                const img = button.querySelector("img");
                img.src = isFavorite ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";

                // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: aria-label ã®æ›´æ–°
                button.setAttribute('aria-label',
                    isFavorite ? 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤' : 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ '
                );

            } catch (error) {
                console.error("Toggle Favorite Error:", error);
                alert("ãŠæ°—ã«å…¥ã‚Šã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        });
    });
});

// å‰Šé™¤ãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆæ”¹å–„ç‰ˆï¼‰
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".delete-button").forEach(button => {
        button.addEventListener("click", async (event) => {
            event.preventDefault();

            const recipeId = button.getAttribute("data-recipe-id");
            const cardElement = document.querySelector(`[data-recipe-id="${recipeId}"]`);
            const recipeName = cardElement ? cardElement.querySelector('.overlay-title').textContent : 'ã“ã®ãƒ¬ã‚·ãƒ”';

            if (!confirm(`ã€Œ${recipeName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            // å‰Šé™¤ä¸­ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const originalText = button.textContent;
            button.textContent = 'å‰Šé™¤ä¸­...';
            button.disabled = true;

            try {
                const response = await fetch(`/recipes/${recipeId}/delete`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ HTTP: " + response.status);
                }

                // å‰Šé™¤æˆåŠŸæ™‚ã€ã‚«ãƒ¼ãƒ‰ã‚’DOMã‹ã‚‰å‰Šé™¤
                if (cardElement) {
                    cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    cardElement.style.opacity = '0';
                    cardElement.style.transform = 'scale(0.95)';

                    setTimeout(() => {
                        cardElement.remove();

                        // ã‚«ãƒ¼ãƒ‰ãŒ0ä»¶ã«ãªã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                        const remainingCards = document.querySelectorAll('.card[style*="display: none"], .card:not([style*="display: none"])');
                        const visibleCards = Array.from(remainingCards).filter(card =>
                            !card.style.display || card.style.display !== 'none'
                        );

                        if (visibleCards.length === 0) {
                            const cardList = document.querySelector('.card-list');
                            if (cardList) {
                                cardList.style.display = 'none';
                            }

                            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆã®ã¿è¿½åŠ 
                            if (!document.querySelector('.no-recipes-message')) {
                                const noRecipeMessage = document.createElement('p');
                                noRecipeMessage.className = 'no-recipes-message';
                                noRecipeMessage.textContent = 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                                document.querySelector('.main-content').appendChild(noRecipeMessage);
                            }
                        }

                        // ä»¶æ•°è¡¨ç¤ºã®æ›´æ–°
                        updateRecipeCount();
                    }, 300);
                }

            } catch (error) {
                console.error("Delete Recipe Error:", error);
                alert("ãƒ¬ã‚·ãƒ”ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");

                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                button.textContent = originalText;
                button.disabled = false;
            }
        });
    });
});

// ä»¶æ•°è¡¨ç¤ºã®æ›´æ–°
function updateRecipeCount() {
    const visibleCards = document.querySelectorAll('.card:not([style*="display: none"])');
    const sectionTitle = document.querySelector('.section-title h2');

    if (sectionTitle) {
        const titleText = sectionTitle.textContent;
        const countMatch = titleText.match(/\((\d+)ä»¶\)/);

        if (countMatch) {
            const newTitle = titleText.replace(/\(\d+ä»¶\)/, `(${visibleCards.length}ä»¶)`);
            sectionTitle.textContent = newTitle;
        }
    }
}

// æ¤œç´¢æ©Ÿèƒ½
if (searchInput) {
    // Enterã‚­ãƒ¼ã§ã®æ¤œç´¢å®Ÿè¡Œ
    searchInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            performSearch();
        }
    });
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½
window.addEventListener('load', () => {
    const loader = document.getElementById('loading');
    const url = new URL(window.location.href);
    const hasLoadingParam = url.searchParams.get('loading') === 'true';

    if (hasLoadingParam) {
        if (loader) {
            loader.style.display = 'flex';

            setTimeout(() => {
                loader.style.display = 'none';
            }, 1500);

            // loading=true ã‚’å‰Šé™¤ï¼ˆå±¥æ­´ã¯æ®‹ã™ãŒç”»é¢ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ãªã„ï¼‰
            url.searchParams.delete('loading');
            window.history.replaceState({}, document.title, url.toString());
        }
    } else {
        if (loader) {
            loader.remove(); // äºŒåº¦ç›®ä»¥é™ã¯DOMã”ã¨å‰Šé™¤ï¼ˆã¡ã‚‰ã¤ãé˜²æ­¢ï¼‰
        }
    }
});

// ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‡ªå‹•éè¡¨ç¤º
document.addEventListener('DOMContentLoaded', function() {
    // åˆæœŸåŒ–å‡¦ç†
    checkScreenSize();

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’æœ€åˆã«èª­ã¿è¾¼ã¿
    darkModeManager.loadSettings();

    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‡ªå‹•éè¡¨ç¤º
    const flashMessages = document.querySelectorAll('.flash-message');
    flashMessages.forEach(message => {
        setTimeout(() => {
            message.style.opacity = '0';
            message.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 300);
        }, 4000); // 4ç§’å¾Œã«éè¡¨ç¤º
    });
});

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ç”»åƒã®é…å»¶èª­ã¿è¾¼ã¿å¯¾å¿œ
if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    observer.unobserve(img);
                }
            }
        });
    });

    // æ—¢å­˜ã® loading="lazy" å±æ€§ã®ã‚ã‚‹ç”»åƒã‚’å¯¾è±¡ã«
    document.querySelectorAll('img[loading="lazy"]').forEach(img => {
        imageObserver.observe(img);
    });
}
</script>
<script src="/assets/js/sidebar-active.js"></script>
</body>
</html>